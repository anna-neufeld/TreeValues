<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial: using ``treevalues`` to perform inference on ``rpart`` trees • treevalues</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial: using ``treevalues`` to perform inference on ``rpart`` trees">
<meta property="og:description" content="treevalues">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">treevalues</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/overview.html">Overview</a>
</li>
<li>
  <a href="../articles/inference_tutorial.html">Tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a></a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/anna-neufeld/treevalues/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="inference_tutorial_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial: using <code>treevalues</code> to perform inference on <code>rpart</code> trees</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/anna-neufeld/treevalues/blob/master/vignettes/inference_tutorial.Rmd"><code>vignettes/inference_tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>inference_tutorial.Rmd</code></div>

    </div>

    
    
<p>In this tutorial, we demonstrate how to use the <code>treevalues</code> package to perform inference on a CART (<span class="citation">Breiman et al. (1984)</span>) tree fit using the <code>rpart</code> package (<span class="citation">Therneau and Atkinson (2019)</span>). Throughout this tutorial, we work with an example tree fit to the Box Lunch Study dataset, which was originally provided in the <code>visTree</code> package (<span class="citation">Venkatasubramaniam and Wolfson (2018)</span>) and described in <span class="citation">Venkatasubramaniam et al. (2017)</span>.</p>
<p>We start by loading the two packages we will be working with. Make sure that <code>remotes</code> is installed by running <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("remotes")</a></code>, then type</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"anna-neufeld/treevalues"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/anna-neufeld/treevalues">treevalues</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart">rpart</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">blsdata</span>, package<span class="op">=</span><span class="st">"treevalues"</span><span class="op">)</span></code></pre></div>
<div id="building-the-tree" class="section level1">
<h1 class="hasAnchor">
<a href="#building-the-tree" class="anchor"></a>Building the tree</h1>
<p>The <code>treevalues</code> package is designed for use with the <code>rpart</code> package, and so all trees should be built using <code>rpart</code>. All trees should be built with the parameter <code>model=TRUE</code>, which saves a copy of the training data inside of the fitted rpart object (this is useful so that the data need not be separately passed to each inference function).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bls.tree</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">kcal24h0</span><span class="op">~</span><span class="va">hunger</span><span class="op">+</span><span class="va">disinhibition</span><span class="op">+</span><span class="va">resteating</span><span class="op">+</span><span class="va">rrvfood</span><span class="op">+</span><span class="va">liking</span><span class="op">+</span><span class="va">wanting</span>, model <span class="op">=</span> <span class="cn">TRUE</span>, data <span class="op">=</span> <span class="va">blsdata</span>, cp<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span></code></pre></div>
<p>The argument <code>cp</code>, or complexity parameter, is a scaled version of the complexity parameter <span class="math inline">\(\lambda\)</span> described in our manuscript. For response variable <span class="math inline">\(y\)</span>, <span class="math inline">\(\lambda =\text{cp} \times \sum_{i=1}^n (y_i-\bar{y})^2\)</span>. The larger the value of <code>cp</code>, the more the tree will be pruned.</p>
<p>We begin by plotting our tree. While we could plot the tree using <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> from the <code>rpart</code> package, or <code>rpart.plot()</code> from the <code>rpart.plot()</code> package, we instead use our internal<code><a href="../reference/treeval.plot.html">treeval.plot()</a></code> function. To start, we set <code>inferenceType=0</code> (no p-values or confidence intervals are computed).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/treeval.plot.html">treeval.plot</a></span><span class="op">(</span><span class="va">bls.tree</span>, inferenceType<span class="op">=</span><span class="fl">0</span><span class="op">)</span></code></pre></div>
<p><img src="inference_tutorial_files/figure-html/unnamed-chunk-4-1.png" width="90%"></p>
<p>A useful feature of the plot above is that it displays node numbers for each region in the tree. We will be using these numbers to identify the regions that we want to perform inference on.</p>
</div>
<div id="inference-on-a-pair-of-sibling-regions-" class="section level1">
<h1 class="hasAnchor">
<a href="#inference-on-a-pair-of-sibling-regions-" class="anchor"></a>Inference on a pair of sibling regions.</h1>
<p>Suppose we are interested in the whether or not the bottom-left split on <code>resteating &gt;= 14</code> is “statistically significant.” This means that we want a p-value for the difference in means between the nodes labeled <code>8</code> and <code>9</code> in the plot above. Inference on this difference in means involves conditioning on the event that the <code>branch</code> that led to this split appeared in the tree; see <span class="citation">Neufeld, Gao, and Witten (2021)</span> for details. We first need to extract this branch.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">branch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getBranch.html">getBranch</a></span><span class="op">(</span><span class="va">bls.tree</span>,<span class="fl">8</span><span class="op">)</span>
<span class="va">branch</span>
<span class="co">## [1] "hunger  &lt; 10.5"           "wanting  &lt; -40.531939285"</span>
<span class="co">## [3] "resteating  &gt;= 13.5"</span></code></pre></div>
<p>We now pass this branch into <code>branchInference</code>. We specify that we are interested in the difference between region <code>8</code> and its sibling by setting <code>type="sib"</code>. The ``branchInference function returns a p-value for the test of the null hypothesis that regions 8 and 9 have the same mean response. It also returns a confidence interval for the true difference in means between the regions. In this case, the confidence interval includes 0 and the p-value is large.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/branchInference.html">branchInference</a></span><span class="op">(</span><span class="va">bls.tree</span>, <span class="va">branch</span>, type<span class="op">=</span><span class="st">"sib"</span><span class="op">)</span>
<span class="va">result</span><span class="op">$</span><span class="va">confint</span>
<span class="co">## [1] -1106.7470   136.5523</span>
<span class="va">result</span><span class="op">$</span><span class="va">pval</span>
<span class="co">## [1] 0.9002555</span></code></pre></div>
<p>By default, a 95% confidence interval is computed. We can change the confidence level by specifying <span class="math inline">\(\alpha\)</span> such that a <span class="math inline">\((1-\alpha)\)</span> confidence interval is returned.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/branchInference.html">branchInference</a></span><span class="op">(</span><span class="va">bls.tree</span>, <span class="va">branch</span>, type<span class="op">=</span><span class="st">"sib"</span>, alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>
<span class="va">result</span><span class="op">$</span><span class="va">confint</span>
<span class="co">## [1] -667.0025  106.8585</span></code></pre></div>
<p>The full <code>result</code> object contains a little bit of additional information, such as the actual conditioning set that was computed and the sample statistic.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span><span class="op">$</span><span class="va">condset</span>
<span class="co">## Object of class Intervals_full</span>
<span class="co">## 2 intervals over R:</span>
<span class="co">## (-543.236399481531, -428.125574226105)</span>
<span class="co">## (428.125574226104, 929.97322312961)</span>
<span class="va">result</span><span class="op">$</span><span class="va">samplemean</span>
<span class="co">##           [,1]</span>
<span class="co">## [1,] -435.6817</span></code></pre></div>
<p>The sample statistic falls relatively close to the boundary of the truncation set, which explains the large p-value and the wide confidence interval. See <span class="citation">Kivaranovic and Leeb (2018)</span> for details.</p>
<p>In our framework, it is assumed that <span class="math inline">\(y_i \sim N(\mu_i, \sigma^2)\)</span> and <span class="math inline">\(\sigma^2\)</span> is assumed known. If no argument <code>sigma_y</code> is provided to the inference function, the conservative estimate <span class="math inline">\(sd(y)\)</span> is used.</p>
</div>
<div id="inference-on-a-single-region" class="section level1">
<h1 class="hasAnchor">
<a href="#inference-on-a-single-region" class="anchor"></a>Inference on a single region</h1>
<p>Suppose that we instead just want a confidence interval for the mean result within region 8. We simply change the <code>type</code> argument.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/branchInference.html">branchInference</a></span><span class="op">(</span><span class="va">bls.tree</span>, <span class="va">branch</span>, type<span class="op">=</span><span class="st">"reg"</span>, alpha<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span>
<span class="co">## </span>
<span class="co">## Sample statistic:  1294.109</span>
<span class="co">## 95% confidence interval: 253.7905, 16592.033</span>
<span class="co">## Type: reg</span>
<span class="co">## p-value for test that param=0: 0.01663048</span>
<span class="co">## Conditioning Set: </span>
<span class="co">## Object of class Intervals_full</span>
<span class="co">## 1 interval over R:</span>
<span class="co">## (1224.75070250313, 1301.6652990799)</span></code></pre></div>
<p>By default, when <code>type="reg"</code>, the function <code><a href="../reference/branchInference.html">branchInference()</a></code> conditions on the event that the exact branch <code>branch</code> appears in the tree. As mentioned in <span class="citation">Neufeld, Gao, and Witten (2021)</span>, there is potential for higher powered inference if we actually condition on all possible permutations of the branch. Conditioning on all possible permutations increases power and, in this case, makes the confidence interval significantly narrower.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/branchInference.html">branchInference</a></span><span class="op">(</span><span class="va">bls.tree</span>, <span class="va">branch</span>, type<span class="op">=</span><span class="st">"reg"</span>, alpha<span class="op">=</span><span class="fl">0.05</span>, permute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## </span>
<span class="co">## Sample statistic:  1294.109</span>
<span class="co">## 95% confidence interval: 253.7905, 2148.2956</span>
<span class="co">## Type: reg</span>
<span class="co">## p-value for test that param=0: 0.01663048</span>
<span class="co">## Conditioning Set: </span>
<span class="co">## Object of class Intervals_full</span>
<span class="co">## 2 intervals over R:</span>
<span class="co">## (1224.75070250313, 1301.6652990799)</span>
<span class="co">## (2868.72223626769, 3427.28431563896)</span></code></pre></div>
<p>While this seems like an argument for always setting <code>permute=TRUE</code>, we note that computations can be prohibitively slow for large trees when <code>permute=TRUE</code>. We also note that adding <code>permute=TRUE</code> tends to make a large difference only in trees where the overall signal is weak. Trees with strong signal and highly significant splits tend to be more stable, and in more stable trees the addition of <code>permute=TRUE</code> does not tend to substantially shorten confidence intervals.</p>
</div>
<div id="inference-for-the-entire-tree" class="section level1">
<h1 class="hasAnchor">
<a href="#inference-for-the-entire-tree" class="anchor"></a>Inference for the entire tree</h1>
<p>We can bypass the need to specify a specific branch by making the following plot, which includes p-values for each split and confidence intervals for each region. We can just see this in a plot. By default, the plot makes 95% confidence intervals for the mean within each region and reports p-values for a test of no difference in means across each split. When looking at a large tree, this plot should be interpreted with care; the p-values have not been corrected for multiple testing.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/treeval.plot.html">treeval.plot</a></span><span class="op">(</span><span class="va">bls.tree</span><span class="op">)</span></code></pre></div>
<p><img src="inference_tutorial_files/figure-html/unnamed-chunk-11-1.png" width="90%"></p>
<p>If we set <code>permute=TRUE</code>, we will get slightly narrower confidence intervals in each node, at the expense of computation time.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/treeval.plot.html">treeval.plot</a></span><span class="op">(</span><span class="va">bls.tree</span>, permute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="inference_tutorial_files/figure-html/unnamed-chunk-12-1.png" width="90%"></p>
</div>
<div id="custom-plotting" class="section level1">
<h1 class="hasAnchor">
<a href="#custom-plotting" class="anchor"></a>Custom plotting</h1>
<p>There are many ways to customize the output of <code>treeval.plot</code>. If the default version is too congested, alternate values of <code>inferenceType</code> can be provided to customize how much information is displayed. Additonal arguments provided will be passed on to `<code>rpart.plot()</code>.</p>
<p>The computationally intensive part of creating the plots is appending p-values and confidence intervals to the tree’s <code>frame</code>. If you plan to plan to play around extensively with plot formatting, you can avoid re-computing the p-values and confidence intervals for each plot by pre-augmenting the tree frame with this information. After running the <code>inferenceFrame</code> function once (this can run slowly, particularly if <code>permute=TRUE</code>), each plot can be made quite quickly.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bls.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/inferenceFrame.html">inferenceFrame</a></span><span class="op">(</span><span class="va">bls.tree</span>, permute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="../reference/treeval.plot.html">treeval.plot</a></span><span class="op">(</span><span class="va">bls.tree</span>, inferenceType<span class="op">=</span><span class="fl">1</span>, printn<span class="op">=</span><span class="cn">TRUE</span>, box.col<span class="op">=</span><span class="st">"white"</span>, nn<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="inference_tutorial_files/figure-html/unnamed-chunk-13-1.png" width="90%"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/treeval.plot.html">treeval.plot</a></span><span class="op">(</span><span class="va">bls.tree</span>, inferenceType<span class="op">=</span><span class="fl">2</span>, printn<span class="op">=</span><span class="cn">TRUE</span>, box.col<span class="op">=</span><span class="st">"white"</span>, fallen.leaves<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="inference_tutorial_files/figure-html/unnamed-chunk-13-2.png" width="90%"></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-breiman1984classification" class="csl-entry">
Breiman, Leo, Jerome Friedman, Charles J Stone, and Richard A Olshen. 1984. <em>Classification and Regression Trees</em>. CRC press.
</div>
<div id="ref-kivaranovic2018expected" class="csl-entry">
Kivaranovic, Danijel, and Hannes Leeb. 2018. <span>“Expected Length of Post-Model-Selection Confidence Intervals Conditional on Polyhedral Constraints.”</span> <em>arXiv Preprint arXiv:1803.01665</em>.
</div>
<div id="ref-neufeld2021treevalues" class="csl-entry">
Neufeld, Anna, Lucy Gao, and Daniela Witten. 2021. <span>“Tree-Values: Selective Inference for Regression Trees.”</span> <em>arXiv Preprint ???</em>
</div>
<div id="ref-therneau2015package" class="csl-entry">
Therneau, Terry, and Beth Atkinson. 2019. <em>Rpart: Recursive Partitioning and Regression Trees</em>.
</div>
<div id="ref-venkat2018package" class="csl-entry">
Venkatasubramaniam, Ashwini, and Julian Wolfson. 2018. <em>visTree: Visualization of Subgroups for Decision Trees</em>.
</div>
<div id="ref-venkatasubramaniam2017decision" class="csl-entry">
Venkatasubramaniam, Ashwini, Julian Wolfson, Nathan Mitchell, Timothy Barnes, Meghan JaKa, and Simone French. 2017. <span>“Decision Trees in Epidemiological Research.”</span> <em><span>Emerging Themes in Epidemiology</span></em> 14 (1): 11.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Anna Neufeld.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
